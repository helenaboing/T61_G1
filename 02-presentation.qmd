---
title: "An√°lise de Vendas e Clientes"
author: "Helena Boing, Alejandra Moreira, Joana Costa, Lohanna Pombo, Pedro Sequeira"
format: revealjs
execute: 
  echo: false #Show (TRUE) or hide (FALSE) the code in the knitted output.
  eval: true #Run (TRUE) or skip (FALSE) code in the chunk.
  warning: true #Show (TRUE) or suppress (FALSE) warnings in the output.
  error: true #Show (TRUE) or suppress (FALSE) errors in the output. If FALSE, knitting stops on error.
  message: false #Show (TRUE) or suppress (FALSE) messages (e.g., package startup messages) in the output.
  output: true #Show (TRUE) or hide (FALSE) output from the chunk. (Not a standard knitr option; may refer to include.)
  cache: true #Cache results so code isn't re-run if unchanged.
  freeze: false #Prevents output from being updated on re-knit.
---

```{r setup, include=FALSE}
# Install required packages if not already installed
required_packages <- c("dplyr", "ggplot2", "lubridate", "scales", "tidyr", "knitr")
new_packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

# Load all required packages
library(dplyr)
library(ggplot2)
library(lubridate)
library(scales)    # For comma() and percent()
library(tidyr)
library(knitr)

# Load data
load("dfinal.Rda")

# Create age groups
dfinal <- dfinal %>%
  mutate(
    FaixaIdade = case_when(
      Idade <= 18 ~ "0-18",
      Idade <= 30 ~ "19-30",
      Idade <= 45 ~ "31-45",
      Idade <= 60 ~ "46-60",
      TRUE ~ "60+"
    )
  )

# Set default theme for all plots
theme_set(theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )
)
```



## Maioria dos clientes tem 31‚Äì45 anos; g√™neros igualmente representados

```{r}
# Prepare data for the pyramid
pyramid_data <- dfinal %>%
  distinct(CustomerKey, Gender, FaixaIdade) %>%
  count(Gender, FaixaIdade) %>%
  mutate(
    n = ifelse(Gender == "M", -n, n),  # Make male values negative for the pyramid effect
    Gender = factor(Gender, levels = c("M", "F"), labels = c("Masculino", "Feminino")),
    FaixaIdade = factor(FaixaIdade, 
                       levels = c("0-18", "19-30", "31-45", "46-60", "60+"),
                       ordered = TRUE)
  )

# Create the pyramid plot
print(
  ggplot(pyramid_data, aes(x = FaixaIdade, y = n, fill = Gender)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("Masculino" = "#4682B4", "Feminino" = "#FF69B4")) +
    coord_flip() +
    scale_y_continuous(
      labels = function(x) abs(x),
      breaks = pretty(pyramid_data$n)
    ) +
    labs(
      title = "Pir√¢mide Demogr√°fica dos Clientes",
      x = "Faixa Et√°ria",
      y = "N√∫mero de Clientes",
      fill = "G√™nero"
    ) +
    theme_minimal() +
    theme(
      legend.position = "bottom",
      plot.title = element_text(hjust = 0.5, face = "bold")
    )
)
```

## Estados Unidos e Austr√°lia concentram a maior parte das vendas
```{r}
# An√°lise por pa√≠s
vendas_por_pais <- dfinal %>%
  group_by(CountryRegionName) %>%
  summarise(
    TotalVendas = sum(SalesAmount),
    NumClientes = n_distinct(CustomerKey),
    NumPedidos = n_distinct(SalesOrderNumber),
    TicketMedio = TotalVendas / NumPedidos
  ) %>%
  arrange(desc(TotalVendas))

# Gr√°fico de barras para vendas por pa√≠s
print(
  ggplot(vendas_por_pais, aes(x = reorder(CountryRegionName, TotalVendas), y = TotalVendas)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    coord_flip() +
    scale_y_continuous(labels = scales::comma) +
    labs(
      title = "Total de Vendas por Pa√≠s",
      x = "Pa√≠s",
      y = "Total de Vendas (‚Ç¨)"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
)
```

## Vendas s√£o dominadas por Calif√≥rnia e estados australianos
```{r}
# An√°lise por regi√£o/estado
vendas_por_regiao <- dfinal %>%
  group_by(CountryRegionName, StateProvinceName) %>%
  summarise(
    TotalVendas = sum(SalesAmount),
    NumClientes = n_distinct(CustomerKey),
    NumPedidos = n_distinct(SalesOrderNumber),
    TicketMedio = TotalVendas / NumPedidos,
    .groups = "drop"
  ) %>%
  arrange(desc(TotalVendas))

# Top 10 regi√µes por vendas
top_regioes <- vendas_por_regiao %>%
  slice_max(TotalVendas, n = 10)

print(
  ggplot(top_regioes, aes(x = reorder(StateProvinceName, TotalVendas), y = TotalVendas)) +
    geom_bar(stat = "identity", fill = "darkgreen") +
    coord_flip() +
    scale_y_continuous(labels = scales::comma) +
    labs(
      title = "Top 10 Regi√µes por Volume de Vendas",
      x = "Regi√£o/Estado",
      y = "Total de Vendas (‚Ç¨)"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
)
```

## Londres e Paris lideram amplamente o volume de vendas entre as cidades
```{r}
# An√°lise por cidade
vendas_por_cidade <- dfinal %>%
  group_by(CountryRegionName, StateProvinceName, City) %>%
  summarise(
    TotalVendas = sum(SalesAmount),
    NumClientes = n_distinct(CustomerKey),
    NumPedidos = n_distinct(SalesOrderNumber),
    TicketMedio = TotalVendas / NumPedidos,
    .groups = "drop"
  ) %>%
  arrange(desc(TotalVendas))

# Top 15 cidades por vendas
top_cidades <- vendas_por_cidade %>%
  slice_max(TotalVendas, n = 15)

print(
  ggplot(top_cidades, aes(x = reorder(City, TotalVendas), y = TotalVendas)) +
    geom_bar(stat = "identity", fill = "darkred") +
    coord_flip() +
    scale_y_continuous(labels = scales::comma) +
    labs(
      title = "Top 15 Cidades por Volume de Vendas",
      x = "Cidade",
      y = "Total de Vendas (‚Ç¨)"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
)
```

## M√©tricas Geogr√°ficas Principais
```{r}
# Calcular m√©tricas principais
metricas_geograficas <- list(
  "Total de Pa√≠ses" = n_distinct(dfinal$CountryRegionName),
  "Total de Regi√µes/Estados" = n_distinct(dfinal$StateProvinceName),
  "Total de Cidades" = n_distinct(dfinal$City),
  "Pa√≠s com Maior Volume" = vendas_por_pais$CountryRegionName[1],
  "Regi√£o com Maior Volume" = vendas_por_regiao$StateProvinceName[1],
  "Cidade com Maior Volume" = vendas_por_cidade$City[1]
)

# Exibir m√©tricas
cat("M√©tricas Geogr√°ficas Principais:\n")
for (i in seq_along(metricas_geograficas)) {
  cat(names(metricas_geograficas)[i], ":", metricas_geograficas[[i]], "\n")
}
```

## Paris lidera densidade de clientes, superando amplamente outras regi√µes
```{r}
# Calcular densidade de clientes por regi√£o
densidade_clientes <- dfinal %>%
  group_by(CountryRegionName, StateProvinceName) %>%
  summarise(
    NumClientes = n_distinct(CustomerKey),
    TotalVendas = sum(SalesAmount),
    NumCidades = n_distinct(City),
    DensidadeClientes = NumClientes / NumCidades,
    TicketMedio = TotalVendas / NumClientes,
    .groups = "drop"
  ) %>%
  arrange(desc(DensidadeClientes))

# Visualizar top 10 regi√µes por densidade de clientes
print(
  ggplot(head(densidade_clientes, 10), 
         aes(x = reorder(StateProvinceName, DensidadeClientes), 
             y = DensidadeClientes)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    coord_flip() +
    labs(
      title = "Top 10 Regi√µes por Densidade de Clientes",
      subtitle = "N√∫mero m√©dio de clientes por cidade",
      x = "Regi√£o",
      y = "Clientes por Cidade"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5)
    )
)
```

## Bikes dominam as vendas nas principais regi√µes
```{r}
# An√°lise de prefer√™ncias por categoria por regi√£o
preferencias_categoria <- dfinal %>%
  group_by(CountryRegionName, StateProvinceName, ProductCategoryName) %>%
  summarise(
    TotalVendas = sum(SalesAmount),
    NumClientes = n_distinct(CustomerKey),
    NumPedidos = n_distinct(SalesOrderNumber),
    .groups = "drop"
  ) %>%
  group_by(CountryRegionName, StateProvinceName) %>%
  mutate(
    PercentualCategoria = TotalVendas / sum(TotalVendas) * 100
  ) %>%
  arrange(desc(TotalVendas))

# Visualizar top 5 regi√µes e suas prefer√™ncias por categoria
top_regioes_categoria <- preferencias_categoria %>%
  group_by(StateProvinceName) %>%
  summarise(TotalVendas = sum(TotalVendas)) %>%
  slice_max(TotalVendas, n = 5) %>%
  pull(StateProvinceName)

print(
  ggplot(preferencias_categoria %>% 
           filter(StateProvinceName %in% top_regioes_categoria),
         aes(x = StateProvinceName, y = PercentualCategoria, fill = ProductCategoryName)) +
    geom_bar(stat = "identity", position = "stack") +
    coord_flip() +
    scale_fill_brewer(palette = "Set3") +
    labs(
      title = "Distribui√ß√£o de Vendas por Categoria nas Top 5 Regi√µes",
      x = "Regi√£o",
      y = "Percentual de Vendas (%)",
      fill = "Categoria"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      legend.position = "bottom"
    )
)
```

## Potencial de Crescimento Regional: Identifica√ß√£o de Oportunidades Priorit√°rias
```{r}
# Identificar mercados com potencial de crescimento
oportunidades_mercado <- dfinal %>%
  group_by(CountryRegionName, StateProvinceName) %>%
  summarise(
    NumClientes = n_distinct(CustomerKey),
    TotalVendas = sum(SalesAmount),
    NumCidades = n_distinct(City),
    TicketMedio = TotalVendas / NumClientes,
    Crescimento = as.numeric(difftime(max(OrderDate), min(OrderDate), units = "days")) / 365,  # Anos de opera√ß√£o
    VendasPorAno = TotalVendas / Crescimento,
    .groups = "drop"
  ) %>%
  # Remover regi√µes com menos de 1 ano de opera√ß√£o
  filter(Crescimento >= 1) %>%
  # Normalizar as vari√°veis
  mutate(
    NumCidadesNorm = (NumCidades - mean(NumCidades)) / sd(NumCidades),
    TicketMedioNorm = (TicketMedio - mean(TicketMedio)) / sd(TicketMedio),
    VendasPorAnoNorm = (VendasPorAno - mean(VendasPorAno)) / sd(VendasPorAno),
    # Calcular score de oportunidade
    ScoreOportunidade = (NumCidadesNorm * 0.4) +  # Peso para n√∫mero de cidades
                        (TicketMedioNorm * 0.3) +  # Peso para ticket m√©dio
                        (VendasPorAnoNorm * 0.3)   # Peso para vendas por ano
  ) %>%
  arrange(desc(ScoreOportunidade))
```

### Metodologia e Fatores de Avalia√ß√£o

- **N√∫mero de Cidades** (40% do score)
  - Indica a cobertura geogr√°fica e capacidade de expans√£o local

- **Ticket M√©dio** (30% do score)
  - Mede o valor m√©dio das transa√ß√µes e poder de compra dos clientes

- **Vendas Anuais** (30% do score)
  - Avalia o volume de neg√≥cios e trajet√≥ria de crescimento

```{=tex}
\begin{align*}
\text{Score de Oportunidade} = &(0.4 \times \text{cidades normalizado}) + \\
&(0.3 \times \text{ticket m√©dio normalizado}) + \\
&(0.3 \times \text{vendas por ano normalizado})
\end{align*}
```

## Crit√©rios e Oportunidades

- ‚úì M√≠nimo de 1 ano de opera√ß√£o
- ‚úì Dados normalizados para comparabilidade
- ‚úì Agrega√ß√£o por regi√£o (pa√≠s/estado)
- ‚úì Filtro de opera√ß√µes recentes

- üéØ **Regi√µes L√≠deres**: Mercados mais promissores para expans√£o e investimentos
- üìä **Ranking Objetivo**: Facilita a aloca√ß√£o de recursos e decis√µes comerciais

## Calif√≥rnia e Inglaterra lideram em potencial de crescimento entre mercados analisados
```{r}
# Visualizar top 10 mercados com maior potencial
print(
  ggplot(head(oportunidades_mercado, 10),
         aes(x = reorder(StateProvinceName, ScoreOportunidade),
             y = ScoreOportunidade)) +
    geom_bar(stat = "identity", fill = "darkgreen") +
    coord_flip() +
    labs(
      title = "Top 10 Mercados com Maior Potencial de Crescimento",
      subtitle = "Score baseado em n√∫mero de cidades, ticket m√©dio e vendas por ano",
      x = "Regi√£o",
      y = "Score de Oportunidade"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5)
    )
)
```

## Detalhes das Top 5 Regi√µes com Maior Potencial
```{r}
# Exibir detalhes das top 5 regi√µes
cat("\nDetalhes das Top 5 Regi√µes com Maior Potencial:\n")
top_5_regioes <- head(oportunidades_mercado, 5)
for (i in 1:nrow(top_5_regioes)) {
  cat("\n", top_5_regioes$StateProvinceName[i], ":\n")
  cat("  N√∫mero de Cidades:", top_5_regioes$NumCidades[i], "\n")
  cat("  Ticket M√©dio: ‚Ç¨", format(round(top_5_regioes$TicketMedio[i], 2), big.mark = ","), "\n")
  cat("  Vendas por Ano: ‚Ç¨", format(round(top_5_regioes$VendasPorAno[i], 2), big.mark = ","), "\n")
  cat("  Score de Oportunidade:", round(top_5_regioes$ScoreOportunidade[i], 2), "\n")
}
```

## Resumo de Penetra√ß√£o de Mercado
```{r}
# Calcular m√©tricas de resumo
resumo_penetracao <- list(
  "Regi√µes com Alta Densidade" = nrow(filter(densidade_clientes, DensidadeClientes > median(DensidadeClientes))),
  "Regi√µes com Baixa Densidade" = nrow(filter(densidade_clientes, DensidadeClientes <= median(DensidadeClientes))),
  "Categoria Mais Popular" = names(sort(table(dfinal$ProductCategoryName), decreasing = TRUE)[1]),
  "Regi√£o com Maior Crescimento" = head(oportunidades_mercado, 1)$StateProvinceName,
  "Ticket M√©dio Global" = mean(dfinal$SalesAmount / dfinal$OrderQuantity),
  "N√∫mero M√©dio de Cidades por Regi√£o" = mean(densidade_clientes$NumCidades)
)

# Exibir resumo
cat("Resumo de Penetra√ß√£o de Mercado:\n")
for (i in seq_along(resumo_penetracao)) {
  cat(names(resumo_penetracao)[i], ":", resumo_penetracao[[i]], "\n")
}
```

## An√°lise de Pre√ßo vs. Demanda por Produto

```{r}
# Preparar dados para o gr√°fico de bolhas
produto_analise <- dfinal %>%
  group_by(ProductKey, ProductName, ProductCategoryName) %>%
  summarise(
    PrecoMedio = mean(UnitPrice),
    QuantidadeTotal = sum(OrderQuantity),
    VendasTotais = sum(SalesAmount),
    NumPedidos = n_distinct(SalesOrderNumber),
    .groups = "drop"
  ) %>%
  # Remover outliers extremos para melhor visualiza√ß√£o
  filter(
    PrecoMedio <= quantile(PrecoMedio, 0.95),
    QuantidadeTotal <= quantile(QuantidadeTotal, 0.95)
  )

# Criar o gr√°fico de bolhas
  ggplot(produto_analise, 
         aes(x = PrecoMedio, 
             y = QuantidadeTotal,
             size = VendasTotais,
             color = ProductCategoryName)) +
    geom_point(alpha = 0.6) +
    scale_size_continuous(
      name = "Vendas Totais (‚Ç¨)",
      labels = scales::comma,
      range = c(3, 15)
    ) +
    scale_color_brewer(
      name = "Categoria",
      palette = "Set1"
    ) +
    scale_x_continuous(
      name = "Pre√ßo M√©dio Unit√°rio (‚Ç¨)",
      labels = scales::comma
    ) +
    scale_y_continuous(
      name = "Quantidade Total Vendida",
      labels = scales::comma
    ) +
    labs(
      title = "Rela√ß√£o entre Pre√ßo, Demanda e Vendas por Produto",
      subtitle = "Tamanho da bolha representa o valor total de vendas"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      legend.position = "right",
      legend.box = "vertical"
    )
```

## M√©tricas Resumidas por Categoria de Produto
```{r}
# Exibir m√©tricas resumidas por categoria
cat("\nM√©tricas por Categoria de Produto:\n")

# Preparar dados para an√°lise
produto_analise <- dfinal %>%
  group_by(ProductKey, ProductName, ProductCategoryName) %>%
  summarise(
    PrecoMedio = mean(UnitPrice),
    QuantidadeTotal = sum(OrderQuantity),
    VendasTotais = sum(SalesAmount),
    NumPedidos = n_distinct(SalesOrderNumber),
    .groups = "drop"
  ) %>%
  # Remover outliers extremos para melhor visualiza√ß√£o
  filter(
    PrecoMedio <= quantile(PrecoMedio, 0.95),
    QuantidadeTotal <= quantile(QuantidadeTotal, 0.95)
  )

# Exibir m√©tricas resumidas
produto_analise %>%
  group_by(ProductCategoryName) %>%
  summarise(
    PrecoMedio = mean(PrecoMedio),
    QuantidadeMedia = mean(QuantidadeTotal),
    VendasTotais = sum(VendasTotais),
    NumProdutos = n(),
    .groups = "drop"
  ) %>%
  arrange(desc(VendasTotais)) %>%
  mutate(
    PrecoMedio = round(PrecoMedio, 2),
    QuantidadeMedia = round(QuantidadeMedia, 0),
    VendasTotais = round(VendasTotais, 2)
  ) %>%
  knitr::kable(
    col.names = c("Categoria", "Pre√ßo M√©dio (‚Ç¨)", "Qtd. M√©dia", "Vendas Totais (‚Ç¨)", "N¬∫ Produtos"),
    format = "simple"
  )
```

## Distribui√ß√£o Geogr√°fica das Vendas

```{r}
# Preparar dados para o mapa
vendas_por_cidade <- dfinal %>%
  group_by(City, StateProvinceName, CountryRegionName) %>%
  summarise(
    TotalVendas = sum(SalesAmount),
    NumClientes = n_distinct(CustomerKey),
    NumPedidos = n_distinct(SalesOrderNumber),
    .groups = "drop"
  ) %>%
  # Remover cidades com vendas muito baixas para melhor visualiza√ß√£o
  filter(TotalVendas > quantile(TotalVendas, 0.1))

# Criar o mapa base
mapa_base <- ggplot() +
  borders("world", colour = "gray85", fill = "gray95") +
  theme_void()

# Adicionar as bolhas de vendas
mapa_vendas <- mapa_base +
  geom_point(
    data = vendas_por_cidade,
    aes(x = as.numeric(factor(StateProvinceName)), 
        y = as.numeric(factor(CountryRegionName)),
        size = TotalVendas,
        color = NumClientes),
    alpha = 0.6
  ) +
  scale_size_continuous(
    name = "Total de Vendas (‚Ç¨)",
    labels = scales::comma,
    range = c(3, 15)
  ) +
  scale_color_gradient(
    name = "N√∫mero de Clientes",
    low = "blue",
    high = "red"
  ) +
  labs(
    title = "Distribui√ß√£o Geogr√°fica das Vendas",
    subtitle = "Tamanho da bolha representa o volume de vendas, cor representa o n√∫mero de clientes"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "right",
    legend.box = "vertical"
  )

# Exibir o mapa
print(mapa_vendas)

# Exibir m√©tricas das top 10 cidades
cat("\nTop 10 Cidades por Volume de Vendas:\n")
vendas_por_cidade %>%
  arrange(desc(TotalVendas)) %>%
  head(10) %>%
  select(City, StateProvinceName, CountryRegionName, TotalVendas, NumClientes) %>%
  mutate(
    TotalVendas = round(TotalVendas, 2),
    TotalVendas = scales::comma(TotalVendas)
  ) %>%
  knitr::kable(
    col.names = c("Cidade", "Estado/Prov√≠ncia", "Pa√≠s", "Total de Vendas (‚Ç¨)", "N¬∫ de Clientes"),
    format = "simple"
  )
```

## Vendas aceleram fortemente a partir de Q2 2018
```{r}
vendas_trimestrais <- dfinal %>%
  mutate(
    Ano = year(OrderDate),
    TrimestreNum = quarter(OrderDate),
    DataTrimestre = make_date(Ano, (TrimestreNum - 1) * 3 + 1, 1),
    Trimestre = paste0("Q", TrimestreNum, " ", Ano)
  ) %>%
  # Filter out Q3 2019 before summarization
  filter(!(Ano == 2019 & TrimestreNum == 3)) %>%
  group_by(Trimestre, DataTrimestre) %>%
  summarise(TotalVendas = sum(SalesAmount, na.rm = TRUE), .groups = "drop") %>%
  arrange(DataTrimestre) %>%
  mutate(Trimestre = factor(Trimestre, levels = unique(Trimestre)))

# Calculate metrics
primeiro_trimestre <- min(vendas_trimestrais$DataTrimestre)
ultimo_trimestre <- max(vendas_trimestrais$DataTrimestre)
primeiro_valor <- vendas_trimestrais$TotalVendas[1]
ultimo_valor <- tail(vendas_trimestrais$TotalVendas, 1)
anos_totais <- as.numeric(difftime(ultimo_trimestre, primeiro_trimestre, units = "days")) / 365.25

# Calculate CAGR
cagr <- (ultimo_valor/primeiro_valor)^(1/anos_totais) - 1

# Calculate YoY growth for each year
crescimento_anual <- vendas_trimestrais %>%
  mutate(Ano = year(DataTrimestre)) %>%
  group_by(Ano) %>%
  summarise(VendasAno = sum(TotalVendas)) %>%
  arrange(Ano) %>%
  mutate(
    CrescimentoYoY = (VendasAno/lag(VendasAno) - 1) * 100
  )

# Calculate average quarterly growth
crescimento_trimestral <- vendas_trimestrais %>%
  mutate(
    CrescimentoTrimestral = (TotalVendas/lag(TotalVendas) - 1) * 100
  ) %>%
  summarise(
    MediaCrescimentoTrimestral = mean(CrescimentoTrimestral, na.rm = TRUE)
  )

# Create the plot with annotations
print(
  ggplot(vendas_trimestrais, aes(x = Trimestre, y = TotalVendas, group = 1)) +
    geom_line(color = "blue", linewidth = 1) +
    geom_point(color = "darkblue") +
    geom_smooth(method = "loess", formula = y ~ x, se = FALSE, color = "red", linetype = "dashed") +
    # Add annotations for metrics
    annotate("text", 
             x = Inf, y = -Inf,
             label = paste0(
               "CAGR: ", scales::percent(cagr, accuracy = 0.1), "\n",
               "Cresc. M√©dio Trimestral: ", scales::percent(crescimento_trimestral$MediaCrescimentoTrimestral/100, accuracy = 0.1), "\n",
               "Cresc. Anual 2018: ", scales::percent(crescimento_anual$CrescimentoYoY[2]/100, accuracy = 0.1), "\n",
               "Cresc. Anual 2019: ", scales::percent(crescimento_anual$CrescimentoYoY[3]/100, accuracy = 0.1)
             ),
             hjust = 1.1, vjust = -0.5,
             linewidth = 3.5,
             family = "sans") +
    labs(
      title = "Volume de Vendas por Trimestre",
      x = "Trimestre",
      y = "Total de Vendas"
    ) +
    scale_y_continuous(labels = scales::comma) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
)
```


## Vendas uniformemente distribu√≠das ao longo da semana
```{r}
# Set locale to English
vendas_por_dia <- dfinal %>%
  mutate(
    Weekday = wday(OrderDate, label = TRUE, abbr = FALSE),
    Weekday = factor(Weekday, 
      levels = c("Sunday", "Monday", "Tuesday", "Wednesday",
                 "Thursday", "Friday", "Saturday"),
      ordered = TRUE)
  ) %>%
  group_by(Weekday) %>%
  summarise(
    TotalSales = sum(SalesAmount, na.rm = TRUE),
    NumOrders = n(),
    .groups = "drop"
  ) %>%
  mutate(
    AverageSales = TotalSales / NumOrders,
    Percentage = TotalSales / sum(TotalSales) * 100
  )

# Create a more informative visualization
print(
  ggplot(vendas_por_dia, aes(x = Weekday, y = TotalSales)) +
    geom_col(fill = "steelblue", alpha = 0.8) +
    geom_text(aes(label = paste0("‚Ç¨", format(round(TotalSales), big.mark = ","))), 
              vjust = -0.5, size = 3.5) +
    geom_text(aes(label = paste0(round(Percentage, 1), "%")), 
              vjust = 2, size = 3.5, color = "white") +
    labs(
      title = "Distribui√ß√£o de Vendas por Dia da Semana",
      subtitle = "Valor total e percentual de vendas",
      x = "Dia da Semana",
      y = "Total de Vendas (‚Ç¨)"
    ) +
    scale_y_continuous(labels = scales::comma) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      axis.text.x = element_text(angle = 45, hjust = 1)
    )
)
```

## Vis√£o Geral do Neg√≥cio

- Total de vendas: `r scales::comma(sum(dfinal$SalesAmount))` ‚Ç¨
- N√∫mero de clientes √∫nicos: `r dplyr::n_distinct(dfinal$CustomerKey)`
- N√∫mero de produtos vendidos: `r dplyr::n_distinct(dfinal$ProductKey)`
- Per√≠odo analisado: `r format(min(dfinal$OrderDate), '%d/%m/%Y')` a `r format(max(dfinal$OrderDate), '%d/%m/%Y')`

## ATV em queda desde ago/2017

```{r}
# Calculate ATV by month
atv_mensal <- dfinal %>%
  group_by(Ano = year(OrderDate), Mes = month(OrderDate)) %>%
  summarise(
    TotalVendas = sum(SalesAmount),
    NumTransacoes = n_distinct(SalesOrderNumber),
    ATV = TotalVendas / NumTransacoes,
    .groups = "drop"
  ) %>%
  mutate(
    Data = make_date(Ano, Mes, 1),
    MesAno = format(Data, "%b/%Y")
  ) %>%
  # Remove the last month as it's incomplete
  filter(Data < max(Data))

# Create ATV trend plot
print(
  ggplot(atv_mensal, aes(x = Data, y = ATV)) +
    geom_line(color = "blue", linewidth = 1) +
    geom_point(color = "darkblue") +
    geom_smooth(method = "loess", formula = y ~ x, se = FALSE, color = "red", linetype = "dashed") +
    labs(
      title = "Evolu√ß√£o do Valor M√©dio de Transa√ß√£o (ATV)",
      subtitle = "Tend√™ncia mensal do valor m√©dio por transa√ß√£o",
      x = "M√™s",
      y = "ATV (‚Ç¨)"
    ) +
    scale_y_continuous(labels = scales::comma) +
    scale_x_date(date_labels = "%b/%Y", date_breaks = "3 months") +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      axis.text.x = element_text(angle = 45, hjust = 1)
    )
)

# Calculate and display overall ATV (excluding last month)
atv_geral <- sum(atv_mensal$TotalVendas) / sum(atv_mensal$NumTransacoes)
cat("\nATV (Valor m√©dio por transa√ß√£o) Geral: ‚Ç¨", format(round(atv_geral, 2), big.mark = ","))
```

## Top 10 Produtos Mais Vendidos
```{r}
top10 <- dfinal %>%
  group_by(ProductKey, ProductName) %>%
  summarise(TotalQuantity = sum(OrderQuantity, na.rm = TRUE), .groups = "drop") %>%
  slice_max(TotalQuantity, n = 10) %>%
  arrange(TotalQuantity)

print(
  ggplot(top10, aes(x = reorder(ProductName, TotalQuantity), y = TotalQuantity)) +
    geom_col(fill = "darkgreen") +
    coord_flip() +
    labs(
      title = "Top 10 Produtos Mais Vendidos",
      x = "Produto",
      y = "Quantidade Vendida"
    ) +
    theme_minimal() +
    theme(
      text = element_text(size = 14),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
)
```

## A maioria dos lucros s√£o gerados pela categoria de produtos "Bike"

```{r}
print(
  dfinal %>%
    group_by(ProductCategoryName) %>%
    summarise(LucroTotal = sum(Lucro, na.rm = TRUE)) %>%
    arrange(desc(LucroTotal)) %>%
    ggplot(aes(x = reorder(ProductCategoryName, LucroTotal), y = LucroTotal)) +
      geom_bar(stat = "identity", fill = "steelblue") +
      coord_flip() +
      labs(
        title = "Lucro Total por Categoria de Produto",
        x = "Categoria",
        y = "Lucro Total"
      ) +
      scale_y_continuous(labels = scales::comma) +
      theme_minimal()
)
```

## Comportamento de Compra

### Taxa de Recompra
```{r, include=FALSE}
clientes_multiplas_compras <- dfinal %>%
  dplyr::group_by(CustomerKey) %>%
  dplyr::summarise(NumCompras = dplyr::n_distinct(SalesOrderNumber)) %>%
  dplyr::filter(NumCompras >= 2) %>%
  nrow()

taxa_recompra <- round(
  clientes_multiplas_compras / dplyr::n_distinct(dfinal$CustomerKey) * 100, 1
)
media_tempo_compras <- dfinal %>%
  dplyr::group_by(CustomerKey) %>%
  dplyr::filter(n() >= 2) %>%
  dplyr::summarise(
    PrimeiraCompra = min(OrderDate),
    UltimaCompra = max(OrderDate),
    NumCompras = n()
  ) %>%
  dplyr::mutate(
    DiasEntreCompras = as.numeric(difftime(UltimaCompra, PrimeiraCompra, units = "days")),
    TempoMedio = DiasEntreCompras / (NumCompras - 1)
  ) %>%
  dplyr::summarise(TempoMedioGlobal = mean(TempoMedio, na.rm = TRUE)) %>%
  dplyr::pull(TempoMedioGlobal) %>%
  round(1)
```

- Clientes com m√∫ltiplas compras: `r clientes_multiplas_compras`
- Taxa de recompra: `r taxa_recompra`%
- Tempo m√©dio entre compras: `r media_tempo_compras` dias

```{r}
# Preparar dados de coorte
library(dplyr)
library(lubridate)

# 1. Identificar a primeira compra de cada cliente
primeiras_compras <- dfinal %>%
  group_by(CustomerKey) %>%
  summarise(PrimeiraCompra = min(OrderDate), .groups = "drop")

# 2. Juntar com os dados originais e calcular o m√™s relativo
cohort_data <- dfinal %>%
  inner_join(primeiras_compras, by = "CustomerKey") %>%
  mutate(
    CohortMonth = format(floor_date(PrimeiraCompra, "month"), "%Y-%m"),
    MesRelativo = (year(OrderDate) - year(PrimeiraCompra)) * 12 +
                  (month(OrderDate) - month(PrimeiraCompra))
  )

# 3. Para cada cliente, coorte e m√™s, contar o n√∫mero de compras
compras_por_mes <- cohort_data %>%
  group_by(CohortMonth, CustomerKey, MesRelativo) %>%
  summarise(NumCompras = n(), .groups = "drop")

# 4. Para m√™s 0, contar apenas clientes com NumCompras > 1
#    Para meses > 0, contar clientes com NumCompras > 0
compras_por_mes <- compras_por_mes %>%
  mutate(
    Recompra = case_when(
      MesRelativo == 0 ~ NumCompras > 1,
      MesRelativo > 0 ~ NumCompras > 0,
      TRUE ~ FALSE
    )
  )

# 5. Calcular o tamanho da coorte
cohort_sizes <- cohort_data %>%
  filter(MesRelativo == 0) %>%
  group_by(CohortMonth) %>%
  summarise(CohortSize = n_distinct(CustomerKey), .groups = "drop")

# 6. Calcular a taxa de reten√ß√£o
cohort_retention <- compras_por_mes %>%
  filter(Recompra) %>%
  group_by(CohortMonth, MesRelativo) %>%
  summarise(ClientesRetidos = n_distinct(CustomerKey), .groups = "drop") %>%
  left_join(cohort_sizes, by = "CohortMonth") %>%
  mutate(Retencao = ClientesRetidos / CohortSize)

#| title: "An√°lise de Reten√ß√£o por Cohorte"
#| echo: false

anos <- unique(year(as.Date(paste0(cohort_retention$CohortMonth, "-01"))))

```{r}
#| results: 'asis'
for (ano in anos) {
  cat("## Reten√ß√£o de Clientes -", ano, "\n\n")
  dados_ano <- cohort_retention %>% filter(year(as.Date(paste0(CohortMonth, "-01"))) == ano)
  print(
    ggplot(dados_ano, aes(x = MesRelativo, y = CohortMonth, fill = Retencao)) +
      geom_tile(color = "white", linewidth = 0.5) +
      scale_fill_gradient2(
        low = "#f7fbff", 
        mid = "#6baed6", 
        high = "#08306b", 
        midpoint = 0.5, 
        labels = scales::percent_format(accuracy = 1),
        name = "Taxa de Reten√ß√£o"
      ) +
      geom_text(
        aes(label = ifelse(!is.na(Retencao) & Retencao > 0, 
                          scales::percent(Retencao, accuracy = 1), "")), 
        size = 3.5, 
        color = "black",
        fontface = "bold"
      ) +
      scale_x_continuous(
        breaks = 0:50, 
        labels = paste0(0:50, ""),
        name = "Meses desde a Primeira Compra (meses)"
      ) +
      labs(
        title = paste("An√°lise de Reten√ß√£o de Clientes -", ano),
        subtitle = "Percentual de clientes que realizaram compras em cada m√™s ap√≥s a primeira compra",
        x = "Meses desde a Primeira Compra (meses)",
        y = "M√™s de Primeira Compra (Ano-M√™s)",
        fill = "Taxa de Reten√ß√£o"
      ) +
      theme_minimal() +
      theme(
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = 10),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
        plot.subtitle = element_text(hjust = 0.5, size = 11, margin = margin(b = 20)),
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 10),
        panel.grid.major = element_line(color = "gray90"),
        panel.grid.minor = element_blank()
      )
  )
  cat("\n\n")
}
```

## Margens por Categoria de Produto
```{r}
# Calcular m√©tricas de rentabilidade por categoria
margens_categoria <- dfinal %>%
  group_by(ProductCategoryName) %>%
  summarise(
    VendasTotais = sum(SalesAmount),
    CustoTotal = sum(StandardCost),
    TaxasTotais = sum(TaxAmt),
    FreteTotal = sum(Freight),
    LucroBruto = VendasTotais - CustoTotal,
    MargemBruta = (LucroBruto / VendasTotais) * 100,
    MargemLiquida = ((LucroBruto - TaxasTotais - FreteTotal) / VendasTotais) * 100,
    .groups = "drop"
  ) %>%
  arrange(desc(MargemLiquida))

# Visualizar margens por categoria
print(
  ggplot(margens_categoria, aes(x = reorder(ProductCategoryName, MargemLiquida))) +
    geom_bar(aes(y = MargemLiquida), stat = "identity", fill = "steelblue", alpha = 0.7) +
    geom_text(aes(y = MargemLiquida, label = paste0(round(MargemLiquida, 1), "%")),
              vjust = -0.5, size = 3.5) +
    labs(
      title = "Margem L√≠quida por Categoria de Produto",
      subtitle = "Percentual de lucro ap√≥s custos diretos, taxas e frete",
      x = "Categoria",
      y = "Margem L√≠quida (%)"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      axis.text.x = element_text(angle = 45, hjust = 1)
    )
)
```

## An√°lise de Custos Operacionais
```{r}
# Calcular m√©tricas de custos operacionais
custos_operacionais <- dfinal %>%
  group_by(ProductCategoryName) %>%
  summarise(
    VendasTotais = sum(SalesAmount),
    FreteTotal = sum(Freight),
    TaxasTotais = sum(TaxAmt),
    FretePorVenda = FreteTotal / VendasTotais * 100,
    TaxasPorVenda = TaxasTotais / VendasTotais * 100,
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols = c(FretePorVenda, TaxasPorVenda),
    names_to = "TipoCusto",
    values_to = "Percentual"
  ) %>%
  mutate(
    TipoCusto = factor(TipoCusto,
      levels = c("FretePorVenda", "TaxasPorVenda"),
      labels = c("Frete", "Taxas")
    )
  )

# Visualizar custos operacionais
print(
  ggplot(custos_operacionais, 
         aes(x = reorder(ProductCategoryName, Percentual), 
             y = Percentual, 
             fill = TipoCusto)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_brewer(palette = "Set2") +
    labs(
      title = "Custos Operacionais por Categoria",
      subtitle = "Percentual de frete e taxas sobre vendas",
      x = "Categoria",
      y = "Percentual sobre Vendas (%)",
      fill = "Tipo de Custo"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom"
    )
)
```

## Efici√™ncia Operacional por Regi√£o
```{r}
# Calcular m√©tricas de efici√™ncia por regi√£o
eficiencia_regional <- dfinal %>%
  group_by(CountryRegionName, StateProvinceName) %>%
  summarise(
    VendasTotais = sum(SalesAmount),
    FreteTotal = sum(Freight),
    TaxasTotais = sum(TaxAmt),
    NumPedidos = n_distinct(SalesOrderNumber),
    FretePorPedido = FreteTotal / NumPedidos,
    TaxasPorPedido = TaxasTotais / NumPedidos,
    .groups = "drop"
  ) %>%
  # Filtrar regi√µes com volume significativo
  filter(VendasTotais > quantile(VendasTotais, 0.1)) %>%
  # Calcular score de efici√™ncia (inverso dos custos)
  mutate(
    ScoreEficiencia = 1 / ((FretePorPedido + TaxasPorPedido) / VendasTotais)
  ) %>%
  arrange(desc(ScoreEficiencia))

# Visualizar top 15 regi√µes por efici√™ncia
print(
  ggplot(head(eficiencia_regional, 15),
         aes(x = reorder(StateProvinceName, ScoreEficiencia),
             y = ScoreEficiencia)) +
    geom_bar(stat = "identity", fill = "darkgreen", alpha = 0.7) +
    coord_flip() +
    labs(
      title = "Top 15 Regi√µes por Efici√™ncia Operacional",
      subtitle = "Score baseado em custos de frete e taxas por pedido",
      x = "Regi√£o",
      y = "Score de Efici√™ncia"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5)
    )
)
```

## Resumo de Rentabilidade e Efici√™ncia
```{r}
# Calcular m√©tricas resumidas
resumo_rentabilidade <- list(
  "Margem Bruta M√©dia" = mean(margens_categoria$MargemBruta),
  "Margem L√≠quida M√©dia" = mean(margens_categoria$MargemLiquida),
  "Custo de Frete M√©dio" = mean(custos_operacionais$Percentual[custos_operacionais$TipoCusto == "Frete"]),
  "Custo de Taxas M√©dio" = mean(custos_operacionais$Percentual[custos_operacionais$TipoCusto == "Taxas"]),
  "Categoria Mais Rent√°vel" = margens_categoria$ProductCategoryName[1],
  "Categoria Menos Rent√°vel" = margens_categoria$ProductCategoryName[nrow(margens_categoria)],
  "Regi√£o Mais Eficiente" = eficiencia_regional$StateProvinceName[1]
)

# Exibir resumo
cat("Resumo de Rentabilidade e Efici√™ncia:\n")
for (i in seq_along(resumo_rentabilidade)) {
  if (grepl("M√©dia", names(resumo_rentabilidade)[i])) {
    cat(names(resumo_rentabilidade)[i], ":", 
        round(resumo_rentabilidade[[i]], 1), "%\n")
  } else {
    cat(names(resumo_rentabilidade)[i], ":", 
        resumo_rentabilidade[[i]], "\n")
  }
}
```